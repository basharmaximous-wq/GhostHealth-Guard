name: Linux Build Reusable

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
        description: 'Build target triple'
      runs-on:
        required: true
        type: string
        description: 'Runner type'
    outputs:
      artifact-name:
        description: 'Name of the built artifact'
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build ${{ inputs.target }}
    runs-on: ${{ inputs.runs-on }}
    outputs:
      artifact-name: ${{ steps.set-artifact-name.outputs.artifact-name }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ inputs.target }}
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ inputs.target }}
      
      - name: Install cross-compilation dependencies
        if: inputs.target != 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      
      - name: Configure for cross-compilation
        if: inputs.target != 'x86_64-unknown-linux-gnu'
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [target.${{ inputs.target }}]
          linker = "aarch64-linux-gnu-gcc"
          EOF
      
      - name: Build release
        run: cargo build --release --target ${{ inputs.target }} --all-features
      
      - name: Strip binary
        run: |
          if [ "${{ inputs.target }}" = "x86_64-unknown-linux-gnu" ]; then
            strip target/${{ inputs.target }}/release/github-webhook
          else
            aarch64-linux-gnu-strip target/${{ inputs.target }}/release/github-webhook
          fi
        continue-on-error: true
      
      - name: Set artifact name
        id: set-artifact-name
        run: echo "artifact-name=github-webhook-${{ inputs.target }}" >> $GITHUB_OUTPUT
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set-artifact-name.outputs.artifact-name }}
          path: target/${{ inputs.target }}/release/github-webhook
          if-no-files-found: error
          retention-days: 30

  test-binary:
    name: Test Binary ${{ inputs.target }}
    needs: build
    runs-on: ${{ inputs.runs-on }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./bin
      
      - name: Make binary executable
        run: chmod +x ./bin/github-webhook
      
      - name: Test binary help
        run: ./bin/github-webhook --help || true
        continue-on-error: true
      
      - name: Verify binary architecture
        run: file ./bin/github-webhook
